<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/my_icon.ico"><link rel="icon" href="/img/my_icon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="魏超"><meta name="keywords" content="魏超,weichao"><meta name="description" content="Reference  Rhythm Game sample    加载 assets 中的 MP3 文件 AAssetDataSource.cpp 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061#include &amp;lt"><meta property="og:type" content="article"><meta property="og:title" content="MP3 数据解码"><meta property="og:url" content="https://weichao.io/c0c8fb5d0298/index.html"><meta property="og:site_name" content="『魏超』的 blog"><meta property="og:description" content="Reference  Rhythm Game sample    加载 assets 中的 MP3 文件 AAssetDataSource.cpp 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061#include &amp;lt"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/MP3-%E6%95%B0%E6%8D%AE%E8%A7%A3%E7%A0%81/MP3-%E6%95%B0%E6%8D%AE%E8%A7%A3%E7%A0%811.jpg"><meta property="article:published_time" content="2021-09-28T08:09:25.000Z"><meta property="article:modified_time" content="2022-12-04T06:04:05.231Z"><meta property="article:author" content="魏超"><meta property="article:tag" content="魏超,weichao"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/MP3-%E6%95%B0%E6%8D%AE%E8%A7%A3%E7%A0%81/MP3-%E6%95%B0%E6%8D%AE%E8%A7%A3%E7%A0%811.jpg"><title>MP3 数据解码 - 『魏超』的 blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1956623_vyed6le6uz.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"weichao.io",root:"/",version:"1.9.4",typing:{enable:!1,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!1},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:2},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"kQcwfNV9f5OTEb51AgXNco4o-gzGzoHsz",app_key:"IVVmse4bqkjcVx2bEJiswbJc",server_url:"https://kqcwfnv9.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>『魏超』的 blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-my-home"></i> <span>首页</span></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-my-document"></i> <span>文档</span></a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/archives/"><i class="iconfont icon-my-archive"></i> <span>归档</span> </a><a class="dropdown-item" href="/categories/"><i class="iconfont icon-my-category"></i> <span>分类</span> </a><a class="dropdown-item" href="/tags/"><i class="iconfont icon-my-tag"></i> <span>标签</span></a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-my-image"></i> <span>图库</span></a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/photo/"><i class="iconfont icon-my-camera"></i> <span>摄影</span> </a><a class="dropdown-item" href="/skiing/"><i class="iconfont icon-my-skiing"></i> <span>滑雪</span> </a><a class="dropdown-item" href="/motor/"><i class="iconfont icon-my-motor"></i> <span>摩托车</span></a></div></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-my-me"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-my-link"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/my_background.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">MP3 数据解码</span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> 魏超 </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2021-09-28 16:09" pubdate>2021年9月28日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 8.5k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 71 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">MP3 数据解码</h1><p class="note note-info">本文最后更新于：1 个月前</p><div class="markdown-body"><h1 id="reference"><a class="markdownIt-Anchor" href="#reference"></a> <strong>Reference</strong></h1><ul><li><a target="_blank" rel="noopener" href="https://github.com/google/oboe/tree/main/samples/RhythmGame" title="https://github.com/google/oboe/tree/main/samples/RhythmGame">Rhythm Game sample</a></li></ul><hr><h1 id="加载-assets-中的-mp3-文件"><a class="markdownIt-Anchor" href="#加载-assets-中的-mp3-文件"></a> <strong>加载 assets 中的 MP3 文件</strong></h1><p><a target="_blank" rel="noopener" href="https://github.com/google/oboe/blob/main/samples/RhythmGame/src/main/cpp/audio/AAssetDataSource.cpp" title="https://github.com/google/oboe/blob/main/samples/RhythmGame/src/main/cpp/audio/AAssetDataSource.cpp">AAssetDataSource.cpp</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utils/logging.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;oboe/Oboe.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;AAssetDataSource.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> !defined(USE_FFMPEG)</span><br><span class="hljs-meta">#<span class="hljs-keyword">error</span> USE_FFMPEG should be defined in app.gradle</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_FFMPEG == 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;FFMpegExtractor.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;NDKExtractor.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>constexpr <span class="hljs-type">int</span> kMaxCompressionRatio&#123;<span class="hljs-number">12</span>&#125;;<br><br>AAssetDataSource *<span class="hljs-title function_">AAssetDataSource::newFromCompressedAsset</span><span class="hljs-params">(AAssetManager &amp;assetManager, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">const</span> AudioProperties targetProperties)</span> &#123;<br>    AAsset *asset = AAssetManager_open(&amp;assetManager, filename, AASSET_MODE_UNKNOWN);<br>    <span class="hljs-keyword">if</span> (!asset) &#123;<br>        LOGE(<span class="hljs-string">&quot;Failed to open asset %s&quot;</span>, filename);<br>        <span class="hljs-keyword">return</span> nullptr;<br>    &#125;<br><br>    <span class="hljs-type">off_t</span> assetSize = AAsset_getLength(asset);<br>    LOGD(<span class="hljs-string">&quot;Opened %s, size %ld&quot;</span>, filename, assetSize);<br><br>    <span class="hljs-comment">// Allocate memory to store the decompressed audio.</span><br>    <span class="hljs-comment">// We don&#x27;t know the exact size of the decoded data until after decoding so we make an assumption about the maximum compression ratio and the decoded sample format (float for FFmpeg, int16 for NDK).</span><br>    <span class="hljs-comment">// 分配内存来存储解压后的音频。</span><br>    <span class="hljs-comment">// 我们直到解码后才知道解码数据的确切大小，因此我们对最大压缩比和解码样本格式（FFmpeg 为 float，NDK 为 int16）进行假设。</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_FFMPEG == true</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">long</span> maximumDataSizeInBytes = kMaxCompressionRatio * assetSize * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>);<br>    <span class="hljs-keyword">auto</span> decodedData = new <span class="hljs-type">uint8_t</span>[maximumDataSizeInBytes];<br><br>    <span class="hljs-type">int64_t</span> bytesDecoded = FFMpegExtractor::decode(asset, decodedData, targetProperties);<br>    <span class="hljs-keyword">auto</span> numSamples = bytesDecoded / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-type">const</span> <span class="hljs-type">long</span> maximumDataSizeInBytes = kMaxCompressionRatio * assetSize * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int16_t</span>);<br>    <span class="hljs-keyword">auto</span> decodedData = new <span class="hljs-type">uint8_t</span>[maximumDataSizeInBytes];<br><br>    <span class="hljs-type">int64_t</span> bytesDecoded = NDKExtractor::decode(asset, decodedData, targetProperties);<br>    <span class="hljs-keyword">auto</span> numSamples = bytesDecoded / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int16_t</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">// Now we know the exact number of samples we can create a float array to hold the audio data</span><br>    <span class="hljs-comment">// 现在我们知道样本的确切数量，我们可以创建一个浮点数组来保存音频数据</span><br>    <span class="hljs-keyword">auto</span> outputBuffer = <span class="hljs-built_in">std</span>::make_unique&lt;<span class="hljs-type">float</span>[]&gt;(numSamples);<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_FFMPEG == 1</span><br>    <span class="hljs-built_in">memcpy</span>(outputBuffer.get(), decodedData, (<span class="hljs-type">size_t</span>)bytesDecoded);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-comment">// The NDK decoder can only decode to int16, we need to convert to floats</span><br>    oboe::convertPcm16ToFloat(reinterpret_cast&lt;<span class="hljs-type">int16_t</span> *&gt;(decodedData), outputBuffer.get(), bytesDecoded / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int16_t</span>));<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    delete[] decodedData;<br>    AAsset_close(asset);<br><br>    <span class="hljs-keyword">return</span> new AAssetDataSource(<span class="hljs-built_in">std</span>::move(outputBuffer), numSamples, targetProperties);<br>&#125;<br></code></pre></td></tr></table></figure><hr><h1 id="解码-mp3-数据"><a class="markdownIt-Anchor" href="#解码-mp3-数据"></a> <strong>解码 MP3 数据</strong></h1><h2 id="使用-ndk-解码"><a class="markdownIt-Anchor" href="#使用-ndk-解码"></a> <strong>使用 NDK 解码</strong></h2><p>参考<a target="_blank" rel="noopener" href="https://source.android.google.cn/devices/media/updatable-media?hl=zh-cn" title="https://source.android.google.cn/devices/media/updatable-media?hl=zh-cn">自定义媒体组件</a>，数据解析包括提取器和解码器。</p><p>提取器进程会自动从 Google 提供的 APEX 软件包和 /system/lib[64]/extractors/ 加载提取器插件，如果默认的媒体提取器无法满足您的需求，您可以在 /system/lib[64]/extractors/ 中放置自定义提取器插件。</p><p>解码器会通过<code>media.player</code>服务查找对应<code>mime</code>的解码器。</p><p>运行时，获取解码器的输入缓冲队列和输出缓冲队列，将提取器处理后的数据放入输入缓冲队列，由解码器处理后的数据会被放入输出缓冲队列，从输出缓冲队列中取出的数据就是可以用于播放的数据。</p><p><a target="_blank" rel="noopener" href="https://github.com/google/oboe/blob/main/samples/RhythmGame/src/main/cpp/audio/NDKExtractor.cpp" title="https://github.com/google/oboe/blob/main/samples/RhythmGame/src/main/cpp/audio/NDKExtractor.cpp">NDKExtractor.cpp</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;media/NdkMediaExtractor.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utils/logging.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cinttypes&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;NDKExtractor.h&quot;</span></span><br><br><span class="hljs-type">int32_t</span> <span class="hljs-title function_">NDKExtractor::decode</span><span class="hljs-params">(AAsset *asset, <span class="hljs-type">uint8_t</span> *targetData, AudioProperties targetProperties)</span> &#123;<br>    LOGD(<span class="hljs-string">&quot;Using NDK decoder&quot;</span>);<br><br>    <span class="hljs-comment">// open asset as file descriptor</span><br>    <span class="hljs-comment">// 打开资产作为文件描述符</span><br>    <span class="hljs-type">off_t</span> start, length;<br>    <span class="hljs-type">int</span> fd = AAsset_openFileDescriptor(asset, &amp;start, &amp;length);<br><br>    <span class="hljs-comment">// Extract the audio frames</span><br>    <span class="hljs-comment">// 提取音频帧</span><br>    AMediaExtractor *extractor = AMediaExtractor_new();<br>    <span class="hljs-type">media_status_t</span> amresult = AMediaExtractor_setDataSourceFd(extractor, fd, static_cast&lt;<span class="hljs-type">off64_t</span>&gt;(start), static_cast&lt;<span class="hljs-type">off64_t</span>&gt;(length));<br>    <span class="hljs-keyword">if</span> (amresult != AMEDIA_OK) &#123;<br>        LOGE(<span class="hljs-string">&quot;Error setting extractor data source, err %d&quot;</span>, amresult);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// Specify our desired output format by creating it from our source</span><br>    <span class="hljs-comment">// 通过从我们的源创建它来指定我们想要的输出格式</span><br>    AMediaFormat *format = AMediaExtractor_getTrackFormat(extractor, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-type">int32_t</span> sampleRate;<br>    <span class="hljs-keyword">if</span> (AMediaFormat_getInt32(format, AMEDIAFORMAT_KEY_SAMPLE_RATE, &amp;sampleRate)) &#123;<br>        LOGD(<span class="hljs-string">&quot;Source sample rate %d&quot;</span>, sampleRate);<br>        <span class="hljs-keyword">if</span> (sampleRate != targetProperties.sampleRate) &#123;<br>            LOGE(<span class="hljs-string">&quot;Input (%d) and output (%d) sample rates do not match. NDK decoder does not support resampling.&quot;</span>, sampleRate, targetProperties.sampleRate);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        LOGE(<span class="hljs-string">&quot;Failed to get sample rate&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;;<br><br>    <span class="hljs-type">int32_t</span> channelCount;<br>    <span class="hljs-keyword">if</span> (AMediaFormat_getInt32(format, AMEDIAFORMAT_KEY_CHANNEL_COUNT, &amp;channelCount)) &#123;<br>        LOGD(<span class="hljs-string">&quot;Got channel count %d&quot;</span>, channelCount);<br>        <span class="hljs-keyword">if</span> (channelCount != targetProperties.channelCount) &#123;<br>            LOGE(<span class="hljs-string">&quot;NDK decoder does not support different input (%d) and output (%d) channel counts&quot;</span>, channelCount, targetProperties.channelCount);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        LOGE(<span class="hljs-string">&quot;Failed to get channel count&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *formatStr = AMediaFormat_toString(format);<br>    LOGD(<span class="hljs-string">&quot;Output format %s&quot;</span>, formatStr);<br><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *mimeType;<br>    <span class="hljs-keyword">if</span> (AMediaFormat_getString(format, AMEDIAFORMAT_KEY_MIME, &amp;mimeType)) &#123;<br>        LOGD(<span class="hljs-string">&quot;Got mime type %s&quot;</span>, mimeType);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        LOGE(<span class="hljs-string">&quot;Failed to get mime type&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// Obtain the correct decoder</span><br>    <span class="hljs-comment">// 获取正确的解码器</span><br>    AMediaCodec *codec = nullptr;<br>    AMediaExtractor_selectTrack(extractor, <span class="hljs-number">0</span>);<br>    codec = AMediaCodec_createDecoderByType(mimeType);<br>    AMediaCodec_configure(codec, format, nullptr, nullptr, <span class="hljs-number">0</span>);<br>    AMediaCodec_start(codec);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 开始解码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">bool</span> isExtracting = <span class="hljs-literal">true</span>;<br>    <span class="hljs-type">bool</span> isDecoding = <span class="hljs-literal">true</span>;<br>    <span class="hljs-type">int32_t</span> bytesWritten = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (isExtracting || isDecoding) &#123;<br>        <span class="hljs-keyword">if</span> (isExtracting) &#123;<br>            <span class="hljs-comment">// Obtain the index of the next available input buffer</span><br>            <span class="hljs-comment">// 获取下一个可用输入缓冲区的索引</span><br>            <span class="hljs-type">ssize_t</span> inputIndex = AMediaCodec_dequeueInputBuffer(codec, <span class="hljs-number">2000</span>);<br>            <span class="hljs-comment">//LOGV(&quot;Got input buffer %d&quot;, inputIndex);</span><br><br>            <span class="hljs-comment">// The input index acts as a status if its negative</span><br>            <span class="hljs-comment">// 输入索引作为一个状态，如果它是负的</span><br>            <span class="hljs-keyword">if</span> (inputIndex &lt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">if</span> (inputIndex == AMEDIACODEC_INFO_TRY_AGAIN_LATER) &#123;<br>                    <span class="hljs-comment">// LOGV(&quot;Codec.dequeueInputBuffer try again later&quot;);</span><br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    LOGE(<span class="hljs-string">&quot;Codec.dequeueInputBuffer unknown error status&quot;</span>);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// Obtain the actual buffer and read the encoded data into it</span><br>                <span class="hljs-comment">// 获取实际缓冲区并将编码数据读入其中</span><br>                <span class="hljs-type">size_t</span> inputSize;<br>                <span class="hljs-type">uint8_t</span> *inputBuffer = AMediaCodec_getInputBuffer(codec, inputIndex, &amp;inputSize);<br>                <span class="hljs-comment">//LOGV(&quot;Sample size is: %d&quot;, inputSize);</span><br><br>                <span class="hljs-type">ssize_t</span> sampleSize = AMediaExtractor_readSampleData(extractor, inputBuffer, inputSize);<br>                <span class="hljs-keyword">auto</span> presentationTimeUs = AMediaExtractor_getSampleTime(extractor);<br>                <span class="hljs-keyword">if</span> (sampleSize &gt; <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-comment">// Enqueue the encoded data</span><br>                    <span class="hljs-comment">// 将编码数据入队</span><br>                    AMediaCodec_queueInputBuffer(codec, inputIndex, <span class="hljs-number">0</span>, sampleSize, presentationTimeUs, <span class="hljs-number">0</span>);<br>                    AMediaExtractor_advance(extractor);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    LOGD(<span class="hljs-string">&quot;End of extractor data stream&quot;</span>);<br>                    isExtracting = <span class="hljs-literal">false</span>;<br><br>                    <span class="hljs-comment">// We need to tell the codec that we&#x27;ve reached the end of the stream</span><br>                    <span class="hljs-comment">// 我们需要告诉编解码器我们已经到达流的末尾</span><br>                    AMediaCodec_queueInputBuffer(codec, inputIndex, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, presentationTimeUs, AMEDIACODEC_BUFFER_FLAG_END_OF_STREAM);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (isDecoding) &#123;<br>            <span class="hljs-comment">// Dequeue the decoded data</span><br>            <span class="hljs-comment">// 将解码数据出列</span><br>            AMediaCodecBufferInfo info;<br>            <span class="hljs-type">ssize_t</span> outputIndex = AMediaCodec_dequeueOutputBuffer(codec, &amp;info, <span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">if</span> (outputIndex &gt;= <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// Check whether this is set earlier</span><br>                <span class="hljs-keyword">if</span> (info.flags &amp; AMEDIACODEC_BUFFER_FLAG_END_OF_STREAM) &#123;<br>                    LOGD(<span class="hljs-string">&quot;Reached end of decoding stream&quot;</span>);<br>                    isDecoding = <span class="hljs-literal">false</span>;<br>                &#125;<br><br>                <span class="hljs-comment">// Valid index, acquire buffer</span><br>                <span class="hljs-type">size_t</span> outputSize;<br>                <span class="hljs-type">uint8_t</span> *outputBuffer = AMediaCodec_getOutputBuffer(codec, outputIndex, &amp;outputSize);<br><br>                <span class="hljs-comment">/*LOGV(&quot;Got output buffer index %d, buffer size: %d, info size: %d writing to pcm index %d&quot;,</span><br><span class="hljs-comment">                     outputIndex,</span><br><span class="hljs-comment">                     outputSize,</span><br><span class="hljs-comment">                     info.size,</span><br><span class="hljs-comment">                     m_writeIndex);*/</span><br><br>                <span class="hljs-comment">// copy the data out of the buffer</span><br>                <span class="hljs-comment">// 从缓冲区复制数据</span><br>                <span class="hljs-built_in">memcpy</span>(targetData + bytesWritten, outputBuffer, info.size);<br>                bytesWritten += info.size;<br>                AMediaCodec_releaseOutputBuffer(codec, outputIndex, <span class="hljs-literal">false</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// The outputIndex doubles as a status return if its value is &lt; 0</span><br>                <span class="hljs-comment">// 如果其值 &lt; 0，则 outputIndex 作为状态返回值加倍</span><br>                <span class="hljs-keyword">switch</span> (outputIndex) &#123;<br>                    <span class="hljs-keyword">case</span> AMEDIACODEC_INFO_TRY_AGAIN_LATER:<br>                        LOGD(<span class="hljs-string">&quot;dequeueOutputBuffer: try again later&quot;</span>);<br>                        <span class="hljs-keyword">break</span>;<br><br>                    <span class="hljs-keyword">case</span> AMEDIACODEC_INFO_OUTPUT_BUFFERS_CHANGED:<br>                        LOGD(<span class="hljs-string">&quot;dequeueOutputBuffer: output buffers changed&quot;</span>);<br>                        <span class="hljs-keyword">break</span>;<br><br>                    <span class="hljs-keyword">case</span> AMEDIACODEC_INFO_OUTPUT_FORMAT_CHANGED:<br>                        LOGD(<span class="hljs-string">&quot;dequeueOutputBuffer: output outputFormat changed&quot;</span>);<br>                        format = AMediaCodec_getOutputFormat(codec);<br>                        LOGD(<span class="hljs-string">&quot;outputFormat changed to: %s&quot;</span>, AMediaFormat_toString(format));<br>                        <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Clean up</span><br>    AMediaFormat_delete(format);<br>    AMediaCodec_delete(codec);<br>    AMediaExtractor_delete(extractor);<br><br>    <span class="hljs-keyword">return</span> bytesWritten;<br>&#125;<br></code></pre></td></tr></table></figure><p>时序图：</p><p><img src="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/MP3-%E6%95%B0%E6%8D%AE%E8%A7%A3%E7%A0%81/MP3-%E6%95%B0%E6%8D%AE%E8%A7%A3%E7%A0%811.jpg" alt=""></p><p>涉及的 NDK 中的源代码：</p><ul><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/ndk/NdkMediaExtractor.cpp" title="https://android.googlesource.com/platform/frameworks/av/+/master/media/ndk/NdkMediaExtractor.cpp">NdkMediaExtractor.cpp</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/NuMediaExtractor.cpp" title="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/NuMediaExtractor.cpp">NuMediaExtractor.cpp</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/03475f5/media/libstagefright/FileSource.cpp" title="https://android.googlesource.com/platform/frameworks/av/+/03475f5/media/libstagefright/FileSource.cpp">FileSource.cpp</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/MediaExtractorFactory.cpp" title="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/MediaExtractorFactory.cpp">MediaExtractorFactory.cpp</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/include/media/MediaExtractorPluginApi.h" title="https://android.googlesource.com/platform/frameworks/av/+/master/include/media/MediaExtractorPluginApi.h">MediaExtractorPluginApi.h</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/MediaExtractor.cpp" title="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/MediaExtractor.cpp">MediaExtractor.cpp</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/InterfaceUtils.cpp" title="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/InterfaceUtils.cpp">InterfaceUtils.cpp</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/RemoteMediaExtractor.cpp" title="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/RemoteMediaExtractor.cpp">RemoteMediaExtractor.cpp</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/Utils.cpp" title="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/Utils.cpp">Utils.cpp</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/08aaabe87960c04ecac180db1fe88b5a7bc2ed3b/media/ndk/NdkMediaFormat.cpp" title="https://android.googlesource.com/platform/frameworks/av/+/08aaabe87960c04ecac180db1fe88b5a7bc2ed3b/media/ndk/NdkMediaFormat.cpp">NdkMediaFormat.cpp</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/ndk/NdkMediaCodec.cpp" title="https://android.googlesource.com/platform/frameworks/av/+/master/media/ndk/NdkMediaCodec.cpp">NdkMediaCodec.cpp</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/base/+/4484bdd2f99a753b0801f0c13ca8a2b7bc38695a/include/media/stagefright/MediaCodec.h" title="https://android.googlesource.com/platform/frameworks/base/+/4484bdd2f99a753b0801f0c13ca8a2b7bc38695a/include/media/stagefright/MediaCodec.h">MediaCodec.h</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/MediaCodec.cpp" title="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/MediaCodec.cpp">MediaCodec.cpp</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/MediaCodecList.cpp" title="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/MediaCodecList.cpp">MediaCodecList.cpp</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/foundation/AHandler.cpp" title="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/foundation/AHandler.cpp">AHandler.cpp</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/348a8ea/include/media/stagefright/foundation/ALooper.h" title="https://android.googlesource.com/platform/frameworks/av/+/348a8ea/include/media/stagefright/foundation/ALooper.h">ALooper.h</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/foundation/ALooper.cpp" title="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/foundation/ALooper.cpp">ALooper.cpp</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/foundation/include/media/stagefright/foundation/AMessage.h" title="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/foundation/include/media/stagefright/foundation/AMessage.h">AMessage.h</a></li><li><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/foundation/AMessage.cpp" title="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/foundation/AMessage.cpp">AMessage.cpp</a></li></ul><h2 id="使用-ffmpeg-解码"><a class="markdownIt-Anchor" href="#使用-ffmpeg-解码"></a> <strong>使用 FFmpeg 解码</strong></h2><p>// TODO</p></div><hr><div><div class="post-metas my-3"></div><div class="license-box my-3"><div class="license-title"><div>MP3 数据解码</div><div>https://weichao.io/c0c8fb5d0298/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>魏超</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2021年9月28日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2022年12月4日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - 相同方式共享"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/39f465f4ad80/" title="在 Android 上运行 FFmpeg Examples"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">在 Android 上运行 FFmpeg Examples</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/cabbeea21c77/" title="MP3 封装格式"><span class="hidden-mobile">MP3 封装格式</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><i class="iconfont icon-my-hexo"></i>&nbsp;<span>博客框架Hexo&nbsp;&nbsp;</span></a> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><i class="iconfont icon-my-theme"></i>&nbsp;<span>博客主题Fluid&nbsp;&nbsp;</span></a> <a href="https://weichao.io" target="_blank" rel="nofollow noopener"><i class="iconfont icon-my-copyright"></i>&nbsp;2022<span>魏超</span></a></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访客数 <span id="leancloud-site-uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>