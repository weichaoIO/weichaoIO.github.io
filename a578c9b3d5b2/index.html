<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/my_icon.ico"><link rel="icon" href="/img/my_icon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="魏超"><meta name="keywords" content="魏超,weichao"><meta name="description" content="“在 Java API 中标注自己是线程安全的类，大多数都不是绝对的线程安全。”"><meta property="og:type" content="article"><meta property="og:title" content="第 13 章：线程安全与锁优化"><meta property="og:url" content="https://weichao.io/a578c9b3d5b2/index.html"><meta property="og:site_name" content="『魏超』的 blog"><meta property="og:description" content="“在 Java API 中标注自己是线程安全的类，大多数都不是绝对的线程安全。”"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E7%AC%AC-13-%E7%AB%A0%EF%BC%9A%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/1.png"><meta property="og:image" content="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E7%AC%AC-13-%E7%AB%A0%EF%BC%9A%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/2.png"><meta property="og:image" content="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E7%AC%AC-13-%E7%AB%A0%EF%BC%9A%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/3.png"><meta property="article:published_time" content="2023-02-07T13:00:00.000Z"><meta property="article:modified_time" content="2023-02-12T03:02:00.521Z"><meta property="article:author" content="魏超"><meta property="article:tag" content="Java"><meta property="article:tag" content="读书笔记"><meta property="article:tag" content="JVM"><meta property="article:tag" content="《深入理解 Java 虚拟机》（第3版）"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E7%AC%AC-13-%E7%AB%A0%EF%BC%9A%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/1.png"><title>第 13 章：线程安全与锁优化 - 『魏超』的 blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/custom.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1956623_vyed6le6uz.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"weichao.io",root:"/",version:"1.9.4",typing:{enable:!1,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!1},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:2},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!0,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"kQcwfNV9f5OTEb51AgXNco4o-gzGzoHsz",app_key:"IVVmse4bqkjcVx2bEJiswbJc",server_url:"https://kqcwfnv9.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>『魏超』的 blog</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-my-home"></i> <span>首页</span></a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-my-document"></i> <span>文档</span></a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/archives/"><i class="iconfont icon-my-archive"></i> <span>归档</span> </a><a class="dropdown-item" href="/categories/"><i class="iconfont icon-my-category"></i> <span>分类</span> </a><a class="dropdown-item" href="/tags/"><i class="iconfont icon-my-tag"></i> <span>标签</span></a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-my-image"></i> <span>图库</span></a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/photo/"><i class="iconfont icon-my-camera"></i> <span>摄影</span> </a><a class="dropdown-item" href="/skiing/"><i class="iconfont icon-my-skiing"></i> <span>滑雪</span> </a><a class="dropdown-item" href="/motor/"><i class="iconfont icon-my-motor"></i> <span>摩托车</span></a></div></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-my-me"></i> <span>关于</span></a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-my-link"></i> <span>友链</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/banner_book.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">第 13 章：线程安全与锁优化</span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> 魏超 </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-02-07 21:00" pubdate>2023年2月7日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 3.6k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 31 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar category-bar" style="margin-right:-1rem"><div class="category-list"><div class="category row nomargin-x"><a class="category-item list-group-item category-item-action col-10 col-md-11 col-xm-11" title="《深入理解 Java 虚拟机》（第3版）" id="heading-f22461cb1c3dd3e3c056aa89b2ff2c90" role="tab" data-toggle="collapse" href="#collapse-f22461cb1c3dd3e3c056aa89b2ff2c90" aria-expanded="true">《深入理解 Java 虚拟机》（第3版） <span class="list-group-count">(13)</span> <i class="iconfont icon-arrowright"></i></a><div class="category-collapse collapse show" id="collapse-f22461cb1c3dd3e3c056aa89b2ff2c90" role="tabpanel" aria-labelledby="heading-f22461cb1c3dd3e3c056aa89b2ff2c90"><div class="category-post-list"><a href="/efb7904b4da2/" title="第 1 章：走近 Java" class="list-group-item list-group-item-action"><span class="category-post">第 1 章：走近 Java</span> </a><a href="/361a7bbccf84/" title="第 2 章：Java 内存区域与内存溢出异常" class="list-group-item list-group-item-action"><span class="category-post">第 2 章：Java 内存区域与内存溢出异常</span> </a><a href="/6d1e0b13ccdb/" title="第 3 章：垃圾收集器和内存分配策略" class="list-group-item list-group-item-action"><span class="category-post">第 3 章：垃圾收集器和内存分配策略</span> </a><a href="/ab9de79741f1/" title="第 4 章：虚拟机性能监控、故障处理工具" class="list-group-item list-group-item-action"><span class="category-post">第 4 章：虚拟机性能监控、故障处理工具</span> </a><a href="/2ee9e69194e2/" title="第 5 章：调优案例分析与实战" class="list-group-item list-group-item-action"><span class="category-post">第 5 章：调优案例分析与实战</span> </a><a href="/816ce5c0985c/" title="第 6 章：类文件结构" class="list-group-item list-group-item-action"><span class="category-post">第 6 章：类文件结构</span> </a><a href="/218f6c813af3/" title="第 7 章：虚拟机类加载机制" class="list-group-item list-group-item-action"><span class="category-post">第 7 章：虚拟机类加载机制</span> </a><a href="/9cc280d67ba5/" title="第 8 章：虚拟机字节码执行引擎" class="list-group-item list-group-item-action"><span class="category-post">第 8 章：虚拟机字节码执行引擎</span> </a><a href="/2f1072badb21/" title="第 9 章：类加载及执行子系统的案例与实战" class="list-group-item list-group-item-action"><span class="category-post">第 9 章：类加载及执行子系统的案例与实战</span> </a><a href="/cb14e0cf9ec3/" title="第 10 章：前端编译与优化" class="list-group-item list-group-item-action"><span class="category-post">第 10 章：前端编译与优化</span> </a><a href="/4131925f181f/" title="第 11 章：后端编译与优化" class="list-group-item list-group-item-action"><span class="category-post">第 11 章：后端编译与优化</span> </a><a href="/d30ab4864c66/" title="第 12 章：Java 内存模型与线程" class="list-group-item list-group-item-action"><span class="category-post">第 12 章：Java 内存模型与线程</span> </a><a href="/a578c9b3d5b2/" title="第 13 章：线程安全与锁优化" class="list-group-item list-group-item-action active"><span class="category-post">第 13 章：线程安全与锁优化</span></a></div></div></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">第 13 章：线程安全与锁优化</h1><p class="note note-info">本文最后更新于：4 天前</p><div class="markdown-body"><p>面向过程的编程思想：以算法为核心，把数据和过程分别作为独立的部分来考虑，数据代表问题空间中的客体，程序代码则用于处理这些数据。<br>面向对象的编程思想：站在现实世界的角度去抽象和解决问题，把数据和行为都看作对象的一部分。</p><p>线程安全：</p><ul><li>定义：当<strong>多个线程</strong>同时访问一个对象时，（1）不用考虑这些线程在运行时环境下的<strong>调度</strong>和<strong>交替执行</strong>（2）不用进行<strong>额外的同步</strong>（3）不用在<strong>调用方</strong>进行任何其他的<strong>协调操作</strong>，调用这个对象的行为都可以获得<strong>正确的结果</strong>，那就称这个对象是线程安全的。</li><li>特征：代码本身封装了所有必要的正确性保障手段，令调用者无须关心多线程下的调用问题，更无须自己实现任何措施来保证多线程环境下的正确调用。</li><li>根据<strong>线程安全程度</strong>由强到弱排序：<ul><li>不可变：<ul><li>基本数据类型：定义时使用 final 关键字修饰。</li><li>对象<code>Java 语言目前没有支持值类型</code>：需要对象自行保证其行为不会对其状态产生任何影响。<ul><li>把对象里面带有状态的变量都声明为 final，这样在构造函数结束之后，它就是不可变的。</li><li>java.lang.String 是典型的不可变对象，它的方法只会返回一个新构造的字符串对象。</li></ul></li></ul></li><li>绝对线程安全：<ul><li>完全满足线程安全的定义，但是需要付出非常高昂的，甚至不切实际的代价<code>在 Java API 中标注自己是线程安全的类，大多数都不是绝对的线程安全</code>。</li></ul></li><li>相对线程安全：<ul><li>弱化了线程安全的定义，只需要保证对这个对象<strong>单次的操作</strong>是线程安全的，对于<strong>连续调用</strong>可能需要在<strong>调用端</strong>使用额外的<strong>同步手段</strong>来保证调用的正确性<code>Java API 中大部分声称线程安全的类都属于这种类型</code>。</li></ul></li><li>线程兼容：<ul><li>对象本身并不是线程安全的，但是可以通过在<strong>调用端</strong>正确地使用<strong>同步手段</strong>来保证对象在并发环境中可以安全地使用<code>Java API 中大部分的类都是线程兼容的</code>。</li></ul></li><li>线程对立：<ul><li>不管调用端是否采取了同步手段，都无法在多线程环境中并发使用代码。</li></ul></li></ul></li><li>同步手段：<ul><li>互斥同步<code>也叫阻塞同步</code>：<ul><li>互斥是实现同步的一种手段，<strong>临界区</strong>、<strong>互斥量</strong>、<strong>信号量</strong>都是常见的互斥实现方式。</li><li>属于悲观的并发策略：其总是认为只要不去做正确的同步措施，就肯定会出现问题，所以无论共享的数据是否真的会出现竞争，都会进行加锁<code>增加了处理成本，虚拟机会优化掉很大一部分不必要的加锁</code>。</li><li>synchronized：<ul><li>一种块结构的同步语法，经过 javac 编译后，会在同步块的前后分别形成 monitorenter 和 monitorexit 字节码指令。<ul><li>这两个字节码指令都需要一个 reference 类型的参数来指定要锁定和解锁的对象。如果指定了对象参数，就以这个对象的引用作为 reference；如果没有指定对象参数，将根据 synchronized 修饰的方法类型，确定是取<strong>对象实例</strong><code>对应实例方法</code>或类型对应的 <strong>Class 对象</strong><code>对应类方法</code>来作为线程要持有的锁。</li><li>执行 monitorenter 指令：首先要去尝试获取对象的锁，如果这个对象没被锁定，或者当前线程已经持有了那个对象的锁<code>推论：被 synchronized 修饰的同步块对同一条线程来说是可重入的</code>，就把锁的计数器的值增加一。如果获取对象锁失败，那当前线程就应当被阻塞等待，直到请求锁定的对象被持有它的线程释放为止<code>推论：被 synchronized 修饰的同步块会无条件地阻塞后面其他线程的进入</code>。</li><li>执行 monitorexit 指令：把锁的计数器的值减少一。一旦计数器的值为零，锁随即就被释放了。</li></ul></li><li>synchronized 是 Java 语言中一个重量级的操作<code>Java 线程是映射到操作系统的原生内核线程之上的，用户态与核心态的转换代价高，状态转换消耗的时间甚至会比用户代码本身执行的时间还要长</code>。</li></ul></li><li>java.util.concurrent.locks.Lock 接口：<ul><li>非块结构，在类库层面实现同步。</li><li>重入锁<code>ReentrantLock</code>：Lock 接口的实现。相比 synchronized 增加了功能：<ul><li>等待可中断：正在等待的线程可以选择放弃等待，改为处理其他事情。</li><li>公平锁<code>使用带布尔值的构造函数，非常影响性能</code>：多个线程在等待同一个锁时，必须按照申请锁的时间顺序来依次获得锁。</li><li>锁可以绑定多个条件：可以同时绑定多个对象。</li></ul></li><li>Lock 应该确保在 finally 块中释放锁，否则一旦受同步保护的代码块中抛出异常，则有可能永远不会释放持有的锁。</li></ul></li></ul></li><li>非阻塞同步：<ul><li>基于<strong>冲突检测</strong>的乐观并发策略：不管风险，先进行操作，如果没有其他线程争用共享数据，那操作就直接成功了；如果共享的数据的确被争用，产生了冲突，那再进行其他的补偿措施<code>比如不断地重试</code>。</li><li>要求操作和冲突检测这两个步骤具备原子性，靠硬件保证某些看起来需要多次操作的行为可以只通过一条处理器指令就能完成：<ul><li>测试并设置。</li><li>获取并增加。</li><li>交换。</li><li>比较并交换<code>CAS</code>。</li><li>加载链接/条件储存。</li></ul></li><li>【引入问题】CAS 的 ABA 问题。<br>【解决问题】引入变量作为版本<code>可能不比阻塞同步高效</code>。</li></ul></li><li>无同步方案<code>有一些代码天生就是线程安全的</code>：<ul><li>可重入代码：不依赖全局变量、存储在堆上的数据、公用的系统资源，用到的状态量都由参数中传入，不调用非可重入的方法。</li><li>线程本地存储：如果能保证共享数据的代码在同一个线程中执行，就把共享数据的可见范围限制在同一个线程之内。<br>* java.lang.ThreadLocal：每一个线程的 Thread 对象中都有一个 ThreadLocalMap 对象，这个对象存储了一组以 ThreadLocal.threadLocalHashCode 为键，以本地线程变量为值的数据。</li></ul></li></ul></li><li>锁优化：<ul><li>自旋锁：<ul><li>如果物理机器有两个或以上的处理器或者处理器核心，就可以让两个或以上的线程同时并行执行，就可以让后面请求锁的那个线程等待<code>让线程执行一个忙循环（自旋）</code>，看看持有锁的线程是否很快就会释放锁。</li><li>【引入问题】如果锁被占用的时间很长，那么自旋的线程只会白白消耗处理器资源。<br>【解决问题】设置自旋的最大次数。如果自旋超过了限定次数仍然没有成功获得锁，就应当使用传统的方式去挂起线程。<ul><li>【引入问题】自旋限定次数值的确定。<br>【解决问题】自适应自旋：由前一次在同一个锁上的自旋时间及锁的拥有者的状态来确定。</li></ul></li></ul></li><li>锁消除：<ul><li>如果虚拟机即时编译器检测<code>判定依据来源于逃逸分析的数据支持</code>到要求同步的代码在运行中不可能存在共享数据竞争，这种锁就会被消除。</li></ul></li><li>锁粗化：<ul><li>如果一系列的连续操作都对同一个对象反复加锁和解锁<code>甚至加锁操作是出现在循环体之中的</code>，会导致不必要的性能损耗，虚拟机会把加锁同步的范围扩展（粗化）到整个操作序列的外部。</li></ul></li><li>轻量级锁和偏向锁：<br><img src="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E7%AC%AC-13-%E7%AB%A0%EF%BC%9A%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/1.png" srcset="/img/loading.gif" lazyload alt=""><br><img src="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E7%AC%AC-13-%E7%AB%A0%EF%BC%9A%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/2.png" srcset="/img/loading.gif" lazyload alt=""><ul><li>轻量级锁：<ul><li>如果没有竞争，轻量级锁便通过 CAS 操作成功避免了使用互斥量<code>重量级锁</code>的开销<code>但如果确实存在锁竞争，轻量级锁反而会比重量级锁更慢</code>。</li><li>加锁过程：</li></ul><ol><li>在代码即将进入同步块的时候，如果此同步对象没有被锁定，虚拟机首先在当前线程的栈帧中建立一个名为<strong>锁记录</strong><code>Lock Record</code>的空间<code>用于存储锁对象目前的 Mark Word 的拷贝——Displaced Mark Word，解锁时还得替换回来</code>：<br><img src="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E7%AC%AC-13-%E7%AB%A0%EF%BC%9A%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E9%94%81%E4%BC%98%E5%8C%96/3.png" srcset="/img/loading.gif" lazyload alt=""></li><li>虚拟机使用 CAS 操作尝试把对象的 Mark Word 更新为<strong>指向锁记录的指针</strong>。<br>如果这个更新动作成功了，即代表该线程拥有了这个对象的锁，并且对象的 Mark Word 的锁标志位将变为 00<code>表示此对象处于轻量级锁定状态</code>。<br>如果这个更新动作失败了<code>意味着至少存在一条线程与当前线程竞争获取该对象的锁</code>，虚拟机会首先检查对象的 Mark Word 是否指向当前线程的栈帧，如果是<code>说明当前线程已经拥有了这个对象的锁</code>，就直接进入同步块继续执行，否则<code>说明这个锁对象已经被其他对象抢占了</code>，<strong>轻量级锁</strong>必须膨胀为<strong>重量级锁</strong><code>锁标志的状态变为 10</code>，此时 Mark Word 中存储的就是<strong>指向重量级锁的指针</strong>，后面等待锁的线程也必须进入阻塞状态。</li></ol><ul><li>解锁过程：<br>使用 CAS 操作把对象当前的 Mark Word 和线程中复制的 Displaced Mark Word 替换回来。<br>如果能够替换成功，那整个同步过程就顺利完成了。<br>如果替换失败，则说明有其他线程尝试过获取该锁，就要在释放锁的同时，唤醒被挂起的线程。</li></ul></li><li>偏向锁：<ul><li>在无竞争状态的情况下把整个同步都消除掉：这个锁会偏向于第一个获得它的线程，如果在接下来的执行过程中，该锁一直没有被其他的线程获取，则持有偏向锁的线程将永远不需要再进行同步。</li><li>加锁过程：<br>当锁对象第一次被线程获取的时候，虚拟机将会把对象头中的<strong>标志位</strong>设置为 01、把<strong>偏向模式</strong>设置为 1，表示进入<strong>偏向模式</strong>。并使用 CAS 操作把获取到这个锁的<strong>线程 ID</strong> 记录在对象的 Mark Word 之中。如果 CAS 操作成功，持有偏向锁的线程以后每次进入这个锁相关的同步块时，虚拟机都可以不再进行任何同步操作。</li><li>解锁过程：<br>一旦出现另外一个线程去尝试获取这个锁的情况，<strong>偏向模式</strong>就马上宣告结束。根据<strong>锁对象目前是否处于被锁定的状态</strong>决定是否撤销偏向<code>偏向模式设置为 0</code>，撤销后标志位恢复到<strong>未锁定</strong><code>标志位为 01</code> 或<strong>轻量级锁定</strong><code>标志位为 00，后续的同步操作按照轻量级锁执行</code>。</li><li>【引入问题】偏向锁的 Mark Word 不存储哈希码。<br>【解决问题】当一个对象已经计算过一致性哈希码后，就无法进入<strong>偏向锁定</strong>状态；当一个对象正处于<strong>偏向锁定</strong>状态，又需要计算其一致性哈希码时，偏向状态会被撤销，并且锁会膨胀为<strong>重量级锁</strong>。</li></ul></li></ul></li></ul></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B%EF%BC%88%E7%AC%AC3%E7%89%88%EF%BC%89/" class="category-chain-item">《深入理解 Java 虚拟机》（第3版）</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/Java/">#Java</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">#读书笔记</a> <a href="/tags/JVM/">#JVM</a> <a href="/tags/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Java-%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B%EF%BC%88%E7%AC%AC3%E7%89%88%EF%BC%89/">#《深入理解 Java 虚拟机》（第3版）</a></div></div><div class="license-box my-3"><div class="license-title"><div>第 13 章：线程安全与锁优化</div><div>https://weichao.io/a578c9b3d5b2/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>魏超</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年2月7日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2023年2月12日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i> </span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="NC - 非商业性使用"><i class="iconfont icon-nc"></i> </span></a><a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><span class="hint--top hint--rounded" aria-label="SA - 相同方式共享"><i class="iconfont icon-sa"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/500af8156fd5/" title="第 2 章：深入理解 Class 文件格式"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">第 2 章：深入理解 Class 文件格式</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/569ff37e6b71/" title="SketchUp Pro 2022 根据户型图建模"><span class="hidden-mobile">SketchUp Pro 2022 根据户型图建模</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><i class="iconfont icon-my-hexo"></i>&nbsp;<span>博客框架Hexo&nbsp;&nbsp;</span></a> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><i class="iconfont icon-my-theme"></i>&nbsp;<span>博客主题Fluid&nbsp;&nbsp;</span></a> <a href="https://weichao.io" target="_blank" rel="nofollow noopener"><i class="iconfont icon-my-copyright"></i>&nbsp;2023<span>魏超</span></a></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访客数 <span id="leancloud-site-uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>